<!-- MODAL DETALHES DO CLIENTE -->
<div x-data @close-detail.window="detailOpen = false" @clientDeleted.window="detailOpen = false">
  <div x-data="{ detailOpen: true }" x-show="detailOpen" x-transition.opacity class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="$dispatch('close-detail')">

    <!-- Card -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-xl p-6 mx-4">

      <!-- Botão Voltar -->
      <div class="flex justify-start mb-4">
        <button type="button" @click="$dispatch('close-detail')" class="text-gray-500 hover:text-gray-800 transition">
          <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </button>
      </div>

      <!-- Conteúdo Principal -->
      <div class="text-center">

        <!-- Avatar -->
        <div class="flex justify-center mb-4">
          {% if client.photo %}
          <img src="{{ client.photo.url }}" alt="{{ client.name }}" class="w-24 h-24 rounded-full object-cover ring-2 ring-green-700 shadow-sm">
          {% else %}
          <div class="w-24 h-24 rounded-full bg-purple-100 ring-2 ring-green-700 flex items-center justify-center shadow-sm">
            <span class="material-symbols-outlined text-4xl text-green-700">person</span>
          </div>
          {% endif %}
        </div>

        <!-- Nome e Apelido -->
        <h2 class="text-xl font-semibold text-gray-900 leading-tight truncate">{{ client.name }}</h2>
        <p class="text-xs text-gray-500 mt-1 truncate">({{ client.nickname|default:"Sem apelido" }})</p>

        <!-- Telefone -->
        <p class="text-sm text-gray-700 mt-2 truncate">{{ client.phone_number }}</p>

        <!-- Dívida -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-5 shadow-sm">
          <p class="text-xs text-gray-700 truncate">{{ client.name }} está devendo</p>
          <p class="text-2xl font-bold text-red-800">
            R$ {{ client.client_debts|floatformat:2 }}
          </p>
        </div>

        <!-- Informações adicionais -->
        <div class="mt-5 space-y-3 text-left border-t pt-3">
          <div>
            <p class="text-[10px] text-gray-500 uppercase tracking-wide">Data de Criação</p>
            <p class="text-sm font-medium text-gray-800">{{ client.created_at|date:"d/m/Y H:i" }}</p>
          </div>
          <div>
            <p class="text-[10px] text-gray-500 uppercase tracking-wide">Última Atualização</p>
            <p class="text-sm font-medium text-gray-800">{{ client.updated_at|date:"d/m/Y H:i" }}</p>
          </div>
        </div>

        <!-- Botões -->
        <div class="flex flex-col gap-3 mt-5">

          <!-- Botão Quitar Dívidas (só aparece se houver dívida) -->
          {% if client.client_debts > 0 %}
          <div x-data="{ showQuitForm: false }" class="w-full">
            <button type="button" @click="showQuitForm = true" class="w-full py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-medium transition flex items-center justify-center gap-2">
              <span class="material-symbols-outlined text-lg">payments</span>
              Quitar Dívidas
            </button>

            <!-- Modal de Quitação -->
            <div x-show="showQuitForm" x-transition.opacity class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]" @click.self="showQuitForm = false">
              <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                  <span class="material-symbols-outlined">payments</span>
                  Quitar Dívidas de {{ client.name }}
                </h3>

                <form hx-post="{% url 'client_clear_debts' client.pk %}" hx-trigger="submit" hx-target="body" hx-swap="none" @htmx:after-request="if (event.detail.successful) { showQuitForm = false; }" class="space-y-4">
                  {% csrf_token %}

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Valor a Quitar (R$)
                    </label>
                    <input type="number" name="amount" step="0.01" min="0.01" max="{{ client.client_debts|floatformat:'2' }}" value="{{ client.client_debts|floatformat:'2' }}" placeholder="Deixe vazio para quitar tudo (R$ {{ client.client_debts|floatformat:2 }})" class="input input-bordered w-full">
                    <p class="text-xs text-gray-500 mt-1">
                      <strong>Dívida total:</strong> R$ {{ client.client_debts|floatformat:2 }}
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                      <strong>Pagamentos fiados:</strong> R$ {{ total_fiado|floatformat:2 }}
                      {% if client.initial_debt > 0 %}
                      <br><strong>Dívida inicial:</strong> R$ {{ client.initial_debt|floatformat:2 }}
                      {% endif %}
                    </p>
                  </div>

                  <div class="flex gap-2">
                    <button type="button" @click="showQuitForm = false" class="flex-1 btn btn-outline">
                      Cancelar
                    </button>
                    <button type="submit" class="flex-1 btn bg-yellow-600 hover:bg-yellow-700 text-white">
                      Quitar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Container para o Modal de Deleção -->
          <div x-data="{ showDeleteConfirm: false }">
            <!-- Botões de Ação -->
            <div class="flex gap-3">
              <!-- Deletar -->
              <button type="button" @click="showDeleteConfirm = true" class="flex-1 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition">
                Deletar
              </button>

              <!-- Cobrar -->
              <button type="button" onclick="window.open('https://wa.me/55{{ client.phone_number }}', '_blank')" class="flex-1 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm font-medium transition">
                Cobrar
              </button>

              <!-- Editar -->
              <button type="button" hx-get="{% url 'client_edit' client.pk %}" hx-target="body" hx-swap="beforeend" class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition">
                Editar
              </button>
            </div>

            <!-- Modal de Confirmação de Deleção -->
            <div x-show="showDeleteConfirm" x-transition.opacity class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]" @click.self="showDeleteConfirm = false">

              <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 p-6">
                <div class="text-center">

                  <!-- Ícone de Alerta -->
                  <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center">
                      <span class="material-symbols-outlined text-4xl text-red-600">warning</span>
                    </div>
                  </div>

                  <!-- Texto de Confirmação -->
                  <h3 class="text-lg font-bold text-gray-900 mb-2">
                    Confirma exclusão deste cliente?
                  </h3>
                  <p class="text-sm text-gray-600 mb-6">
                    Esta ação não pode ser desfeita.
                  </p>

                  <!-- Botões -->
                  <div class="flex gap-3">
                    <button type="button" @click="showDeleteConfirm = false" class="flex-1 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium transition">
                      Cancelar
                    </button>

                    <form hx-post="{% url 'client_delete' client.pk %}" hx-swap="none" hx-trigger="submit" @htmx:after-request.window="if (event.detail.xhr.status === 200) { showDeleteConfirm = false; $dispatch('close-detail'); }" class="flex-1">
                      {% csrf_token %}
                      <button type="submit" class="w-full py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition">
                        OK
                      </button>
                    </form>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>