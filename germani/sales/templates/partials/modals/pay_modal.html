<dialog id="pay-modal" class="modal" data-balance="{{ sale.balance|stringformat:'f' }}" x-data="payModal()" x-init="initBalance()">

  <div class="modal-box w-11/12 max-w-md border-green-500 bg-base-200 text-base-content">

    <h3 class="font-extrabold text-lg mb-4 text-green-700 flex items-center">
      <span class="material-symbols-outlined">attach_money</span>
      Registrar Pagamento
    </h3>

    <!-- Mensagem de erro -->
    <div x-show="error" class="alert alert-error mb-3" x-transition>
      <span class="material-symbols-outlined">error</span>
      <span x-text="error"></span>
    </div>

    <form id="pay-form" method="POST" hx-post="{% url 'pay_sale' sale.id %}" hx-target="#sale-items" hx-swap="innerHTML"
      hx-on::response-error="handleHTMXError(event)" @submit="validateBeforeSubmit($event)"
      class="flex flex-col gap-3">

      {% csrf_token %}

      <div class="flex gap-2 items-center">
        <input type="number" step="0.01" min="0.01" name="amount"
          placeholder="{% if sale.balance <= 0 %}Não há saldo a pagar{% else %}Valor a pagar{% endif %}"
          class="input input-bordered flex-1 {% if sale.balance <= 0 %}input-disabled{% endif %}" 
          {% if sale.balance <= 0 %}disabled{% endif %}
          :max="balance" 
          x-model="amountStr" 
          @input="clearError(); checkLimit(); updateAmount()" 
          required>
        {% if sale.balance > 0 %}
        <button type="button" 
          @click="fillBalance()" 
          class="btn btn-outline btn-sm"
          title="Preencher com o saldo total">
          Total
        </button>
        {% endif %}
      </div>

      <select name="method" class="select select-bordered">
        <option value="pix">PIX</option>
        <option value="cash">Dinheiro</option>
        <option value="card">Cartão</option>

        {% if sale.client_id %}
        <option value="fiado">Conta do Cliente</option>
        {% endif %}
      </select>

      <input type="text" name="note" placeholder="Observação (opcional)" class="input input-bordered">

      <div class="flex justify-between items-center gap-2 mt-2">

        {% if sale.balance < 0 %} <h3 class="font-extrabold text-lg text-yellow-600">
          Crédito: R$ {{ sale.credit_amount|floatformat:'2' }}
          </h3>

          <div class="flex gap-2">
            <button type="button" class="btn btn-outline btn-error" @click="$el.closest('dialog').close()">
              Cancelar
            </button>

            <button type="button" class="btn btn-success text-white" disabled>
              Não é possível pagar
            </button>
          </div>

          {% else %}

          <h3 class="font-extrabold text-lg text-green-700">
            Saldo: R$ {{ sale.balance|floatformat:'2' }}
          </h3>

          <div class="flex gap-2">
            <button type="button" class="btn btn-outline btn-error" @click="$el.closest('dialog').close()">
              Cancelar
            </button>

            <button type="submit" class="btn btn-success text-white">Registrar</button>
          </div>

          {% endif %}

      </div>
    </form>
  </div>

  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
  function payModal() {
    // Obter o balance do atributo data do dialog
    // Usar setTimeout para garantir que o DOM esteja pronto
    let balanceNum = 0;
    
    // Tentar obter o valor imediatamente
    const dialog = document.getElementById('pay-modal');
    if (dialog) {
      const balanceAttr = dialog.getAttribute('data-balance') || '0';
      // Converter string para número, tratando vírgula como ponto decimal
      let balanceStr = String(balanceAttr).replace(',', '.').replace(/\s/g, '').trim();
      balanceNum = parseFloat(balanceStr);
      if (isNaN(balanceNum)) {
        balanceNum = 0;
      }
    }
    
    // Debug: verificar se o valor está correto
    console.log('Balance inicializado:', balanceNum);
    
    return {
      balance: balanceNum,
      amount: 0,
      amountStr: '',
      error: '',
      
      initBalance() {
        // Garantir que o balance seja atualizado quando o modal for aberto
        const dialog = document.getElementById('pay-modal');
        if (dialog) {
          const balanceAttr = dialog.getAttribute('data-balance') || '0';
          let balanceStr = String(balanceAttr).replace(',', '.').replace(/\s/g, '').trim();
          const newBalance = parseFloat(balanceStr);
          if (!isNaN(newBalance)) {
            this.balance = newBalance;
            console.log('Balance atualizado no init:', this.balance);
          }
        }
      },

      updateAmount() {
        // Converter string para número, mantendo precisão decimal
        const input = document.querySelector('#pay-modal input[name="amount"]');
        if (input && input.value) {
          const val = parseFloat(input.value);
          if (!isNaN(val)) {
            this.amount = val;
          }
        }
      },

      fillBalance() {
        // Preencher o campo com o saldo total
        const input = document.querySelector('#pay-modal input[name="amount"]');
        if (input) {
          input.value = this.balance.toFixed(2);
          this.amountStr = this.balance.toFixed(2);
          this.amount = this.balance;
          this.clearError();
        }
      },

      clearError() {
        this.error = ''
      },

      setError(msg) {
        this.error = msg;
        setTimeout(() => {
          document.querySelector('#pay-modal .alert-error')
            ?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 30);
      },

      checkLimit() {
        // Obter o valor do input diretamente para garantir precisão com centavos
        const amountInput = document.querySelector('#pay-modal input[name="amount"]');
        const amountValue = amountInput && amountInput.value ? parseFloat(amountInput.value) : 0;
        
        if (isNaN(amountValue) || amountValue <= 0) {
          // Não mostrar erro se o campo estiver vazio ou sendo digitado
          if (amountInput && amountInput.value && amountInput.value.trim() !== '') {
            this.setError("O valor do pagamento deve ser no mínimo R$ 0,01.");
          } else {
            this.clearError();
          }
        } else if (amountValue > 0 && amountValue < 0.01) {
          this.setError("O valor do pagamento deve ser no mínimo R$ 0,01.");
        } else if (amountValue > this.balance) {
          this.setError(
            `O valor informado (R$ ${amountValue.toFixed(2)}) é maior que o saldo devido (R$ ${this.balance.toFixed(2)})`
          );
        } else {
          this.clearError();
        }
      },

      async validateBeforeSubmit(e) {
        // Obter o valor do input diretamente para garantir precisão com centavos
        const amountInput = e.target.querySelector('input[name="amount"]');
        const amountValue = amountInput && amountInput.value ? parseFloat(amountInput.value) : 0;
        
        // Validar se o valor é válido (maior ou igual a 0.01)
        if (isNaN(amountValue) || amountValue < 0.01) {
          this.setError("O valor do pagamento deve ser no mínimo R$ 0,01.");
          e.preventDefault();
          return false;
        }

        if (amountValue > this.balance) {
          this.setError(
            `O valor informado (R$ ${amountValue.toFixed(2)}) é maior que o saldo devido (R$ ${this.balance.toFixed(2)})`
          );
          e.preventDefault();
          return false;
        }

        if (this.balance <= 0) {
          this.setError("Não é possível registrar pagamento quando o saldo é zero ou negativo.");
          e.preventDefault();
          return false;
        }
        
        // Atualizar o amount no modelo para garantir que está sincronizado
        this.amount = amountValue;

        // Verificar se é PIX - se for, mostrar QR code
        const methodSelect = e.target.querySelector('select[name="method"]');
        const method = methodSelect ? methodSelect.value : '';
        
        if (method === 'pix') {
          e.preventDefault();
          
          // Buscar ou criar o dialog do PIX
          let pixDialog = document.getElementById('pix-preview');
          if (!pixDialog) {
            pixDialog = document.createElement('dialog');
            pixDialog.id = 'pix-preview';
            pixDialog.className = 'modal';
            document.body.appendChild(pixDialog);
          }
          
          try {
            // Usar o valor do input diretamente para garantir precisão com centavos
            const amountInput = e.target.querySelector('input[name="amount"]');
            const amount = amountInput ? amountInput.value : (this.amount || '');
            const url = new URL("{% url 'sale_pix_qr' sale.id %}", window.location.origin);
            if (amount) url.searchParams.set('amount', amount);
            
            const res = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Falha ao carregar QR');
            const html = await res.text();
            
            pixDialog.innerHTML = html;
            
            pixDialog.querySelectorAll('[data-action="close"]').forEach(btn => {
              btn.addEventListener('click', () => {
                pixDialog.close();
                e.target.dataset.skipQr = '1';
                e.target.requestSubmit();
              });
            });
            
            if (typeof pixDialog.showModal === 'function') pixDialog.showModal();
          } catch (err) {
            console.error(err);
            this.setError('Não foi possível carregar o QR. Tente novamente.');
          }
          
          return false;
        }

        // Para outros métodos, submeter via HTMX normalmente
        // Não prevenir - deixar HTMX processar
        return true;
      },

      handleHTMXError(event) {
        if (event.detail?.xhr?.responseText) {
          this.setError(event.detail.xhr.responseText.trim());
        }
      }
    }
  }
</script>